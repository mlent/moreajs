/*! morea 2014-11-14 */
define(function(){"use strict";function a(a,b){return this.el="string"==typeof a?document.querySelector(a):a,this.options=b||{},null===this.el?(console.log("Could not find DOM object."),this):(this.init(),this)}return a.prototype.defaults={mode:"display",data:[],dataUrl:void 0,orientation:"vertical",user:"tester",targets:[]},a.prototype.init=function(){if(this.config=this._extend({},this.defaults,this.options),this._addEvent(window,"resize",this._toggleOrientation.bind(this)),this.render(),0!==this.config.data.length){this.data=this.config.data;for(var a=0;a<this.data.length;a++){var b=this;"play"===this.config.mode&&this.data[a].words.forEach(function(a){a.answers=b._clone(a.translations)||[],a.translations=[]}),this.renderSentence(this.data[a])}}else{this.data=[];var c=this.config.dataUrl;"create"!==this.config.mode&&(c+="?full=True"),this._fetchData(c,function(a){var b=this;this.data[0]=a;var c;if(c="create"!==this.config.mode?Object.keys(this.data[0].translations).filter(function(a){return 0===b.config.targets.length?!0:-1!==b.config.targets.indexOf(a)}):["fr","en","fa","hr","de","pt"],this.config.langs=c.reduce(function(a,c){var d={fr:"French",en:"English",fa:"Farsi",hr:"Croatian",de:"German",pt:"Portuguese"};return a[c]={hr:d[c],dir:"fa"===c?"rtl":"ltr",resource_uri:b.data[0].translations[c]},a},{}),this.config.langs[this.data[0].words[0].lang]={hr:"Greek",resource_uri:this.data[0].resource_uri,dir:"ltr"},this._updateLoadingFeedback(),"create"!==this.config.mode)for(var d=0;d<c.length;d++){var e=this.config.langs[c[d]].resource_uri+"?full=True";this._fetchData(e)}}.bind(this))}},a.prototype._fetchData=function(a,b){var c=new XMLHttpRequest;a+="create"!==this.config.mode?"&format=json":"",c.open("GET",a,!0),c.onload=function(){if(c.status>=200&&c.status<400){var a=this,d=c.responseText;"object"!=typeof d&&(d=JSON.parse(d)),d.lang=d.words[0].lang,"play"===this.config.mode&&d.words.forEach(function(b){b.answers=a._clone(b.translations)||[],b.answers=b.answers.filter(function(b){return-1!==a.config.targets.indexOf(b.lang)}),b.translations=[]}),this.data.push(d),b&&b(d),this.renderSentence(d),this._updateLoadingFeedback()}else this.showFeedback("There was an error loading data.")}.bind(this),c.send(null)},a.prototype._updateLoadingFeedback=function(){var a=Object.keys(this.config.langs).length,b=this.el.querySelectorAll(".sentence").length;Object.keys(this.config.langs).length===this.el.querySelectorAll(".sentence").length||"create"===this.config.mode?(this.showFeedback("Done loading &mdash; get started!",!0),this.config.starttime=new Date):this.showFeedback("Loading alignment "+(b+1)+"/"+a)},a.prototype.focusNode=function(a){for(var b=a.target.dataset.translations.split(","),c=this.el.querySelectorAll("span"),d=this._getAllRelatedAlignments(b),e=0;e<c.length;e++)-1!==d.indexOf(c[e].dataset.cts)&&c[e].addClass("hovered")},a.prototype.editNode=function(a){if("display"===this.config.mode)return!1;var b=this.el.querySelectorAll("span");if(null!==this.header.querySelector("form.open")&&this.toggleForm(),-1!==this.el.className.indexOf("editing"))return void(-1!==a.target.className.indexOf("linked")?this.removeLink(a):this.createLink(a));a.target.addClass("selected"),a.target.addClass("linked");var c=a.target.dataset.translations.split(","),d=this._getAllRelatedAlignments(c);this.el.addClass("editing");for(var e=0;e<b.length;e++)-1!==d.indexOf(b[e].dataset.cts)&&b[e].addClass("linked"),b[e].setAttribute("data-tooltip","")},a.prototype.stopEditing=function(a){a&&a.preventDefault(),this.unfocusNodes();for(var b=this.el.querySelectorAll("span"),c=this.el.querySelectorAll(".linked"),d=0;d<b.length;d++)b[d].removeClass("linked"),b[d].removeClass("selected");if(this.el.removeClass("editing"),"play"===this.config.mode){if(this.checkAnswers(),0===c.length)return;for(var e,f=[],g=[],h=[],d=0;e=c[d];d++)g.push(e.dataset.cts),h.push(e.innerHTML),f.push(-1!==e.className.indexOf("bou")?100:-1!==e.className.indexOf("wiggle")?0:50);var i=_.reduce(f,function(a,b){return a+b},0)/f.length;this.sendSubmission(i,g,h)}},a.prototype.checkAnswers=function(){for(var a=this.el.querySelectorAll("span"),b=[].concat.apply([],this.data.map(function(a){return a.words})),c="",d=0,e=0;e<a.length;e++){var f=a[e].dataset.cts,g=a[e].dataset.translations;g=0===g.length?[]:g.split(",");var h=b.filter(function(a){return a.CTS===f})[0].answers.map(function(a){return a.CTS});if(0!==g.length){var i=g.filter(function(a){return-1!==h.indexOf(a)});d+=i.length,i.length===h.length&&0!==h.length?(this.el.querySelector('span[data-cts="'+f+'"]').removeClass("wiggle"),this.el.querySelector('span[data-cts="'+f+'"]').addClass("bou")):g.length<h.length?(this.el.querySelector('span[data-cts="'+f+'"]').removeClass("wiggle"),this.el.querySelector('span[data-cts="'+f+'"]').removeClass("bou"),c=0===c.length?"This phrase requires more words.":c):0!==g.length?(this.el.querySelector('span[data-cts="'+f+'"]').removeClass("bou"),this.el.querySelector('span[data-cts="'+f+'"]').addClass("wiggle"),c=0===c.length?"One or more of these words isn't right.":c):(this.el.querySelector('span[data-cts="'+f+'"]').removeClass("wiggle"),this.el.querySelector('span[data-cts="'+f+'"]').removeClass("bou"))}else this.el.querySelector('span[data-cts="'+f+'"]').removeClass("wiggle"),this.el.querySelector('span[data-cts="'+f+'"]').removeClass("bou")}c=0===c.length?"Great Job!":c,this.showFeedback(c,!0),this.updatePoints(d)},a.prototype.sendSubmission=function(a,b,c){var d,e="submitted";if(window.CustomEvent){var f={detail:{accuracy:a,task:"align_sentence",response:c,encounteredWords:b,starttime:this.config.starttime}};d=new CustomEvent(e,f)}else d=document.createEvent(e);console.log(f.detail),this.el.dispatchEvent(d)},a.prototype.updatePoints=function(a){var b=this.header.querySelector(".points"),c=parseInt(b.innerHTML);a>c?(b.addClass("bou"),b.addClass("success"),this._delayRemoveClass(b,"bou",3e3),this._delayRemoveClass(b,"success",3e3)):c>a&&(b.addClass("wiggle"),b.addClass("error"),this._delayRemoveClass(b,"wiggle",3e3),this._delayRemoveClass(b,"error",3e3)),b.innerHTML=a},a.prototype.showFeedback=function(a,b){var c=this.header.querySelector(".feedback");c.removeClass("hidden"),c.innerHTML=a,b&&this._delayAddClass(c,"hidden",3e3)},a.prototype.createLink=function(a){a.target.addClass("linked"),a.target.addClass("hovered");var b=(a.target.dataset.cts,Array.prototype.slice.call(this.el.querySelectorAll(".linked")));b=b.concat(Array.prototype.slice.call(this.el.querySelectorAll(".hovered")));for(var c,d=[],e=this,f=0;c=b[f];f++)-1===d.indexOf(c.dataset.cts)&&d.push(c.dataset.cts);var g=[].concat.apply([],this.data.map(function(a){return a.words})),h=g.filter(function(a){return-1!==d.indexOf(a.CTS)});this.data.forEach(function(a,b){for(var c,f=a.words,b=0;c=f[b];b++)-1!==d.indexOf(c.CTS)&&(e.insertTranslation(c,h),e.insertTranslation(h,c))})},a.prototype.insertTranslation=function(a,b){var c;if(void 0!==a[0]){var d=a.map(function(a){return a.CTS});if(c=0===b.translations.filter(function(a){return-1!==d.indexOf(a.CTS)}).length,!c)return;if(a=a.filter(function(a){return a.lang!==b.lang&&("grc"===a.lang||"grc"===b.lang)&&a.CTS!==b.CTS}),0===a.length)return;b.translations=b.translations.concat(a),d=a.map(function(a){return a.CTS});var e=this.el.querySelector('span[data-cts="'+b.CTS+'"]'),f=e.dataset.translations;f=0===f.length?[]:f.split(","),e.setAttribute("data-translations",f.concat(d).join(",")),e.addClass("linked")}if(void 0!==b[0])for(var g=0;g<b.length;g++){b[g].translations=b[g].translations||[];var c=0===b[g].translations.filter(function(b){return b.CTS===a.CTS}).length;if(c&&b[g].lang!==a.lang&&b[g].CTS!==a.CTS&&("grc"===a.lang||"grc"===b[g].lang)){b[g].translations.push(a);var e=this.el.querySelector('span[data-cts="'+b[g].CTS+'"]'),f=e.dataset.translations;f=0===f.length?[]:f.split(","),f.push(a.CTS),e.setAttribute("data-translations",f.join(",")),e.addClass("linked")}}},a.prototype.removeLink=function(a){a.target.removeClass("linked"),a.target.removeClass("hovered");var b=a.target.dataset.cts,c=Array.prototype.slice.call(this.el.querySelectorAll(".linked"));c=c.concat(Array.prototype.slice.call(this.el.querySelectorAll(".selected")));for(var d,e=[],f=this,g=0;d=c[g];g++)e.push(d.dataset.cts);var h=[].concat.apply([],this.data.map(function(a){return a.words})),i=h.filter(function(a){return a.CTS===b})[0];this.data.forEach(function(a,b){for(var c,d=a.words,b=0;c=d[b];b++)-1!==e.indexOf(c.CTS)&&(f.removeTranslation(c,i),f.removeTranslation(i,c))})},a.prototype.removeTranslation=function(a,b){if(b.translations){b.translations=b.translations.filter(function(b){return b.CTS!==a.CTS});var c=[].concat.apply([],b.translations.map(function(a){return a.CTS})),d=this.el.querySelector('span[data-cts="'+b.CTS+'"]');d.setAttribute("data-translations",c.join(",")),d=this.el.querySelector('span[data-cts="'+a.CTS+'"]');var e=d.dataset.translations;e=0===e.length?[]:e.split(","),e.splice(e.indexOf(a.CTS),1),d.setAttribute("data-translations",e.join(","))}},a.prototype.unfocusNodes=function(){for(var a=this.el.querySelectorAll("span"),b=0;b<a.length;b++)a[b].removeClass("hovered")},a.prototype._getAllRelatedAlignments=function(a){for(var b=[],c=[].concat.apply([],this.data.map(function(a){return a.words})),d=0;d<c.length;d++)-1===b.indexOf(c[d].CTS)&&-1!==a.indexOf(c[d].CTS)&&b.push(c[d].CTS);for(var d=0;d<c.length;d++)if(c[d].translations){var e=c[d].translations.map(function(a){return a.CTS});this._anyMatchInArray(b,e)&&b.push(c[d].CTS)}return b},a.prototype.toggleForm=function(a){a&&a.preventDefault();var b=this.header.querySelector("#btn-add-translation"),c=this.header.querySelector("form");null!==c&&"open"!==c.className?(c.className="open",b.innerHTML="Close"):null!==c&&"open"===c.className?(c.className="",b.innerHTML="Add Translation"):(b.innerHTML="Close",this._renderForm(),this.header.querySelector("form").className="open")},a.prototype._toggleOrientation=function(){this.el.offsetWidth<1e3||0==this.el.offsetWidth?this.el.addClass("horizontal"):this.el.removeClass("horizontal")},a.prototype._renderForm=function(){var a=document.createElement("form"),b=document.createElement("select");b.setAttribute("name","lang");var c=document.createElement("option");c.innerHTML="Select Language";for(var d=Object.keys(this.config.langs).sort(),e=0;e<d.length;e++){var f=document.createElement("option");f.setAttribute("value",d[e]),f.innerHTML=this.config.langs[d[e]].hr,b.appendChild(f)}var g=document.createElement("textarea"),h=document.createElement("label");h.setAttribute("for","token-option");var i=document.createElement("input");i.setAttribute("type","checkbox"),i.setAttribute("id","token-option"),i.setAttribute("name","tokenize-punctuation"),h.appendChild(i),h.innerHTML+="Split punctuation as tokens";var j=document.createElement("button");j.setAttribute("type","submit"),j.setAttribute("value","Align Text"),j.innerHTML="Align Text",j.addEventListener("click",this.addTranslation.bind(this)),a.appendChild(g),a.appendChild(b),a.appendChild(h),a.appendChild(j),this.header.appendChild(a),this.header.querySelector('input[name="tokenize-punctuation"]').checked=!0},a.prototype.addTranslation=function(a){a.preventDefault();var b=this.header.querySelector("form");this.toggleForm();var c=b.querySelector("textarea"),d=c.value.trim();c.value="",b.querySelector('input[name="tokenize-punctuation"]').checked&&(d=d.replace(/([\.,-\/#!$%\^&\*;:{}=\-_`~()])/g," $1"));var e=d.split(" "),f=b.querySelector("select").value,g=this._getCtsProperty(this.data[0].CTS,"work");g.translation=this.config.user+"-"+f;var h=this._setCtsProperty(this.data[0].CTS,{work:g});if(null!==this.el.querySelector('[data-cts="'+h+'"]'))return void alert("You are already working on this language. Click 'Edit' to modify it.");for(var i=[],j=0;j<e.length;j++)i.push({value:e[j],lang:f,length:e[j].length,translations:[],CTS:h+":"+(j+1)});var e={CTS:h,length:i.length,sentence:b.querySelector("textarea").value.trim(),translations:{},lang:f,words:i};this.data.splice(1,0,e),this.renderSentence(this.data[1])},a.prototype._renderHeader=function(){this.header=document.createElement("div"),this.header.className="header","display"===this.config.mode&&(this.header.style.display="none");var a=document.createElement("div");a.className="btn-container";var b=document.createElement("a");b.innerHTML="Link",b.className="btn",b.setAttribute("id","btn-done"),b.setAttribute("href","#");var c=document.createElement("a");c.innerHTML="Edit",c.className="btn",c.setAttribute("id","btn-edit"),c.setAttribute("href","#");var d=document.createElement("a");d.innerHTML="Merge",d.className="btn",d.setAttribute("id","btn-merge"),d.setAttribute("href","#");var e=document.createElement("div");if(e.className="tracker","create"===this.config.mode){var f=document.createElement("a");f.innerHTML="Add Translation",f.className="btn",f.setAttribute("id","btn-add-translation"),f.setAttribute("href","#"),f.addEventListener("click",this.toggleForm.bind(this)),this.header.appendChild(f)}if("play"===this.config.mode){var g=document.createElement("div");g.className="points",g.innerHTML="0",e.appendChild(g)}var h=document.createElement("div");h.className="feedback",e.appendChild(h),a.appendChild(b),b.addEventListener("click",this.stopEditing.bind(this)),this._addEvent(window,"keypress",this.stopEditing.bind(this)),this.header.appendChild(e),this.header.appendChild(a),this.el.appendChild(this.header),0===this.config.data.length?this.showFeedback("Initializing Alignment Editor..."):this.showFeedback("Done Loading",!0)},a.prototype.render=function(){-1===this.el.className.indexOf("morea")&&this.el.addClass("morea"),this.el.innerHTML="",this._renderHeader()},a.prototype.renderSentence=function(a){var b,c=100/this.data.length;if(null===this.el.querySelector('[data-cts="'+a.CTS+'"]')&&(b=document.createElement("div"),b.className="sentence",b.setAttribute("lang",a.lang),b.setAttribute("data-cts",a.CTS),b.style.width=c+"%"),"rtl"===this.config.langs[a.lang].dir&&b.addClass("rtl"),b.innerHTML="","grc"!==a.lang&&"edit"===this.config.mode){var d=document.createElement("a");d.setAttribute("href","#"),d.setAttribute("title","Close Translation"),d.innerHTML="&times;",b.appendChild(d)}for(var e=0;e<a.words.length;e++){var f=document.createElement("span");f.innerHTML=a.words[e].value;var g="";a.words[e].translations&&(g=a.words[e].translations.map(function(a){return a.CTS}).toString()),f.setAttribute("data-translations",g),f.setAttribute("data-cts",a.words[e].CTS),f.setAttribute("lang",a.lang),f.addEventListener("mouseover",this.focusNode.bind(this)),f.addEventListener("mouseout",this.unfocusNodes.bind(this)),f.addEventListener("click",this.editNode.bind(this)),b.appendChild(f),b.appendChild(document.createTextNode(" "))}for(var h=this.el.querySelectorAll(".sentence"),i=0;i<h.length;i++)h[i].style.width=c+"%";this.el.appendChild(b)},a.prototype._extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},a.prototype._anyMatchInArray=function(a,b){var c,d,e,f=!1,g={};for(c=0,d=a.length;d>c;c++)e=a[c],g[e]=!0;for(c=0,d=b.length;!f&&d>c;c++)e=b[c],f=!!g[e];return f},a.prototype._addEvent=function(a,b,c){null!==a&&"undefined"!=typeof a&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c)},a.prototype._splitCts=function(a){var b=a.split(":"),c=b[3].split("."),d={urn:b[0],cts:b[1],namespace:b[2],work:{textgroup:c[0],text:c[1],translation:c[2]},sentence:b[4]};return 6===b.length&&(d.word=b[5]),d},a.prototype._getCtsProperty=function(a,b){var c=this._splitCts(a);return c[b]},a.prototype._setCtsProperty=function(a,b){var c=this._splitCts(a);for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);var e=Object.keys(c.work).map(function(a){return c.work[a]}),f=c.urn+":"+c.cts+":"+c.namespace+":"+e.join(".")+":"+c.sentence;return c.word&&(f+=":"+c.word),f},a.prototype._clone=function(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},a.prototype._delayAddClass=function(a,b,c){setTimeout(function(){a.addClass(b)},c)},a.prototype._delayRemoveClass=function(a,b,c){setTimeout(function(){a.removeClass(b)},c)},HTMLElement.prototype.removeClass||(HTMLElement.prototype.removeClass=function(a){for(var b="",c=this.className.trim().split(" "),d=0;d<c.length;d++)c[d]!==a&&(b+=c[d]+" ");this.className=b.trim()}),HTMLElement.prototype.addClass||(HTMLElement.prototype.addClass=function(a){-1===this.className.indexOf(a)&&(this.className+=" "+a),this.className.trim()}),a});